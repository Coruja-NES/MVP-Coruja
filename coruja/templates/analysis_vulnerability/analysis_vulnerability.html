{% extends "base.html" %}

{% block css %}
<style>
.list-group{
max-height: 70vh;
overflow-y: auto;
-webkit-overflow-scrolling: touch;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
<div class="row d-flex align-items-center justify-content-center">
    <div class="col-md-3 text-left">
        <div class="d-flex flex-column">
            <h6 class="mb-3">Ativos</h6>
            <div id="category"></div>
        </div>
    </div>
    <div class="col-md-9 my-auto" id="subcategory">
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function () {
    var csrf_token = '{{ csrf_token() }}';

    function _accordionItem(counter, name) {
        return `<div class="accordion-item">
            <h2 class="accordion-header" id="heading${counter}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                 data-bs-target="#collapse${counter}" aria-expanded="false" aria-controls="collapse${counter}">
                    ${name}
                </button>
            </h2>
            <div id="collapse${counter}" class="accordion-collapse collapse" 
            aria-labelledby="heading${counter}" data-bs-parent="#accordionCool">
                <div class="accordion-body">
                    <ul class="ul"></ul>
                </div>
            </div>
        </div>`
    }

    function renderSubcategories(category) {

        // Recebe o ativo atualizado
        $.ajax({
            url: '{{ url_for("api.get_categories") }}',
            type: 'POST',
            headers: {
            'X-CSRFToken': csrf_token
            },
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify({
            'av_id': '{{ analysis_vulnerability.id }}'
            }),
            success: (data, textStatus, jqXHR) => {
                category = data.categories[category.id]

                $('#subcategories').empty();
                $.ajax({
                url: '{{ url_for("api.get_subcategories") }}',
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrf_token
                },
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    'av_id': '{{ analysis_vulnerability.id }}',
                    'ca_id': category.id,
                }),
                success: (data, textStatus, jqXHR) => {

                    let accordion = $('<div class="accordion" id="accordionCool">');
                    let counter = 0;

                    for (let subcategoryId in data) {

                        counter++;
                        let subcategory = data[subcategoryId];
                        let accordionItem = $(_accordionItem(counter, subcategory.name));
                        let ul = accordionItem.find(".ul");

                        for (let vuln of subcategory.vulnerabilities) {

                            let scoreContainer = $(
                            `<div class="d-flex justify-content-between align-items-center mb-2" data-id="${vuln.id}">
                                <span>${vuln.name} - ${vuln.description || 'Sem descrição'}</span>
                                <div class="d-flex justify-content-between" id="score-inputs">
                                </div>
                            </div>`
                            );

                            let updateButton = $(
                                `<button type="button" class="btn btn-success
                                m-1" disabled><i class="bi bi-check-lg"></i></button>`
                            )

                            let isFetching = false;
                            let scoreInputs = scoreContainer.find("#score-inputs");
                            
                            let input = $(
                                `<input class="form-control text-center m-1" style="width: 50px;"
                                title="score" data-bs-toggle="tooltip" data-bs-placement="top" id="score"
                                data-score-type="score" value = "${vuln.score}" >`
                            );

                            input.change(function(){
                                if(!isFetching) updateButton.prop("disabled", false)
                            })
                            scoreInputs.append(input);

                            scoreInputs.append(updateButton);
                            
                            ul.append(scoreContainer);
                            let vuln_id = scoreContainer.data("id");

                            scoreContainer.find("button").click(function () {
                                isFetching = true
                                updateButton.prop("disabled", true);
                                updateButton.empty();
                                updateButton.append(`<div class="spinner-border spinner-border-sm" role="status"></div>`);
                                
                                let score = scoreContainer.find("#score").val()
                                
                                $.ajax({
                                url: '{{ url_for("api.update_vulnerability_score") }}',
                                type: 'POST',
                                data: JSON.stringify({
                                    vuln_id: vuln_id, scores: scores
                                }),
                                contentType: 'application/json',
                                dataType: 'json',
                                headers: {
                                    'X-CSRFToken': csrf_token
                                },
                                success: (data, textStatus, jqXHR) => {
                                    isFetching = false;
                                    updateButton.empty();
                                    updateButton.append(`<i class="bi bi-check-lg"></i>`);

                                },
                                error: (error) => {
                                    console.log(error);
                                }
                                });
                            });
                        }
                        let addvuln = $(
                            `<a class="btn btn-outline-success btn my-3" href="{{url_for("analysis_vulnerability.create_adverse_vuln")}}?parent_id=${subcategoryId}">
                            <i class="bi bi-plus-lg"></i> Adicionar Vulnerabilidade
                            </a>`
                        )
                        accordionItem.find(".accordion-body").append(addvuln);
                        accordion.append(accordionItem);
                    }
                    let addsubcategory = $(
                        `<a class="btn btn-outline-primary btn my-3" href="{{url_for("analysis_vulnerability.create_subcategory")}}?parent_id=${category.id}">
                        <i class="bi bi-plus-lg"></i> Adicionar Subcategoria
                        </a>`
                    )
                    
                    $('#subcategorys').append(accordion);
                    $('#subcategorys').append(addsubcategory);
                    $('[data-bs-toggle="tooltip"]').tooltip();
                }
                });
                    }
            });
    }

    $.ajax({
        url: '{{ url_for("api.get_categories") }}',
        type: 'POST',
        headers: {
        'X-CSRFToken': csrf_token
        },
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({
        'av_id': '{{ analysis_vulnerability.id }}'
        }),
        success: (data, textStatus, jqXHR) => {
        $('#category').empty();
        let listGroup = $('<div class="list-group">');
        
        for (let key in data.categories) {
            let category = data.categories[key];
            let listItem = $(`<button class="list-group-item list-group-item-vuln py-2" data-id="${category.id}">
            ${category.title}</button>`);
            listItem.click(() => {
            renderSubcategories(category);
            });
            listGroup.append(listItem);
        };
        let addCategory = $(`<a class="btn btn-outline-primary list-group-item py-2" href="{{url_for("analysis_vulnerability.create_category", parent_id=analysis_vulnerability.id)}}"
        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Criar Categoria">
        <i class="bi bi-plus-lg"></i>
        </a>`);
        listGroup.append(addCategory);
        $('#category').append(listGroup);
        },
        error: (error) => {
        console.log(error);
        }
    });
})
</script>
{% endblock %}