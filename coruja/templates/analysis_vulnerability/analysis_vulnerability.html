{% extends "base.html" %}

{% block css %}
<style>
.list-group{
max-height: 70vh;
overflow-y: auto;
-webkit-overflow-scrolling: touch;
}
</style>
{% endblock %}

{% block content %}

<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
        <div class="modal-header">
            <h1 class="modal-title fs-5" id="infoModalLabel">Notas de Vulnerabilidade</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
            <div class="row d-flex justify-content-center">
                <div class="col">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col"><strong>Descrição</strong></th>
                                <th scope="col"><strong>Grau</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, value in table_info.items() %}
                            <tr>
                                <td scope="col">{{key}}</td>
                                <td scope="col">{{value}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
    </div>
    </div>

<div class="container-fluid mt-5">
<div class="row d-flex align-items-center justify-content-center">
    <div class="col-md-3 text-left">
        <div class="d-flex flex-column">
            <h6 class="mb-3">Categorias</h6>
            <div id="category"></div>
        </div>
    </div>
    <div class="col-md-9 my-auto" id="subcategory">
    </div>
</div>
</div>

<!-- Botão de informação -->
<div class="position-fixed bottom-0 end-0 m-2">
    <button
    class="btn m-5 btn-lg btn-circle"
    data-bs-toggle="modal" data-bs-target="#infoModal"
    >
    <i class="bi bi-info-circle"></i>
    </button>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function () {
    var csrf_token = '{{ csrf_token() }}';

    function _accordionItem(counter, name) {
        return `<div class="accordion-item">
            <h2 class="accordion-header" id="heading${counter}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                 data-bs-target="#collapse${counter}" aria-expanded="false" aria-controls="collapse${counter}">
                    ${name}
                </button>
            </h2>
            <div id="collapse${counter}" class="accordion-collapse collapse" 
            aria-labelledby="heading${counter}" data-bs-parent="#accordionCool">
                <div class="accordion-body">
                    <ul class="ul"></ul>
                </div>
            </div>
        </div>`
    }

    function renderSubcategories(category) {

        // Recebe o ativo atualizado
        $.ajax({
            url: '{{ url_for("api.get_categories") }}',
            type: 'POST',
            headers: {
            'X-CSRFToken': csrf_token
            },
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify({
            'av_id': '{{ analysis_vulnerability.id }}'
            }),
            success: (data, textStatus, jqXHR) => {
                category = data.categories[category.id]

                $('#subcategory').empty();
                $.ajax({
                url: '{{ url_for("api.get_subcategories") }}',
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrf_token
                },
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    'av_id': '{{ analysis_vulnerability.id }}',
                    'c_id': category.id,
                }),
                success: (data, textStatus, jqXHR) => {

                    if(data.subcategories.length == 0){
                        $('#subcategory').append(`<p class="text-center">Sem subcategorias criadas</p>`)
                        return
                    }

                    let accordion = $('<div class="accordion" id="accordionCool">');
                    let counter = 0;

                    for (let subcategoryId in data.subcategories) {

                        counter++;
                        let subcategory = data.subcategories[subcategoryId];
                        let accordionItem = $(_accordionItem(counter, subcategory.name));
                        let ul = accordionItem.find(".ul");
                        

                        for (let vuln of subcategory.vulnerabilities) {

                            let scoreContainer = $(
                            `<div class="d-flex justify-content-between align-items-center mb-2" data-id="${vuln.id}">
                                <span>${vuln.name} - ${vuln.description || 'Sem descrição'}</span>
                                <div class="d-flex justify-content-between" id="score-inputs">
                                </div>
                            </div>`
                            );

                            let updateButton = $(
                                `<button type="button" class="btn btn-success
                                m-1" disabled><i class="bi bi-check-lg"></i></button>`
                            )

                            let isFetching = false;
                            let scoreInputs = scoreContainer.find("#score-inputs");
                            
                            let input = $(
                                `<input class="form-control text-center m-1" style="width: 50px;"
                                title="score" data-bs-toggle="tooltip" data-bs-placement="top" id="score"
                                data-score-type="score" value = "${vuln.score}" >`
                            );

                            input.change(function(){
                                if(!isFetching) updateButton.prop("disabled", false)
                            })
                            scoreInputs.append(input);

                            scoreInputs.append(updateButton);
                            
                            ul.append(scoreContainer);
                            let vuln_id = scoreContainer.data("id");

                            scoreContainer.find("button").click(function () {
                                isFetching = true
                                updateButton.prop("disabled", true);
                                updateButton.empty();
                                updateButton.append(`<div class="spinner-border spinner-border-sm" role="status"></div>`);
                                
                                let score = scoreContainer.find("#score").val()
                                
                                $.ajax({
                                url: '{{ url_for("api.update_vulnerability_score") }}',
                                type: 'POST',
                                data: JSON.stringify({
                                    vuln_id: vuln_id, score: score
                                }),
                                contentType: 'application/json',
                                dataType: 'json',
                                headers: {
                                    'X-CSRFToken': csrf_token
                                },
                                success: (data, textStatus, jqXHR) => {
                                    isFetching = false;
                                    updateButton.empty();
                                    updateButton.append(`<i class="bi bi-check-lg"></i>`);

                                },
                                error: (error) => {
                                    console.log(error);
                                }
                                });
                            });
                        }
                        accordion.append(accordionItem);
                    }
                    
                    $('#subcategory').append(accordion);
                    $('[data-bs-toggle="tooltip"]').tooltip();
                }
                });
                    }
            });
    }

    $.ajax({
        url: '{{ url_for("api.get_categories") }}',
        type: 'POST',
        headers: {
        'X-CSRFToken': csrf_token
        },
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({
        'av_id': '{{ analysis_vulnerability.id }}'
        }),
        success: (data, textStatus, jqXHR) => {
        $('#category').empty();
        console.log(data)
        let listGroup = $('<div class="list-group">');
        
        for (let key in data.categories) {
            let category = data.categories[key];
            let listItem = $(`

                <div class="list-group-item list-group-item-action d-flex justify-content-between">
                    <div class="btn sub-open" data-id="${category.id}">${category.name}</div>
                    {% if proxy_access(kind_object="analysis", kind_access="delete", object_id=analysis_vulnerability.analysis.id)%}
                    <div class="btn me-2 sub-delete"><i class="bi bi-trash"></i></div>
                    {% endif %}
                </div>
            
            `);
            listItem.find(".sub-open").click(() => {
                renderSubcategories(category);
            });

            listItem.find(".sub-delete").click(() => {
                $.ajax({
                url: '{{ url_for("api.delete_category") }}',
                type: 'POST',
                headers: {
                'X-CSRFToken': csrf_token
                },
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                'av_id': '{{ analysis_vulnerability.id }}',
                'c_id': category.id
                }),
                success: (data, textStatus, jqXHR) => {
                    // recarrega a página
                    window.location.reload()
                }
                })

            })

            listGroup.append(listItem);
        };
        $('#category').append(listGroup);
        $('[data-bs-toggle="tooltip"]').tooltip();
        },
        error: (error) => {
        console.log(error);
        }
    });
})
</script>
{% endblock %}