    {% extends "base.html" %}

    {% block css %}
    <style>
    .list-group{
    max-height: 70vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    }
    </style>
    {% endblock %}

    {% block content %}
    <div class="container-fluid mt-3">
    <div class="row d-flex align-items-center justify-content-center">
    <div class="col-md-3 text-left">
        <div class="d-flex flex-column p-3">
            <h6 class="mb-3">Ativos</h6>
            <div id="actives"></div>
        </div>
    </div>
    <div class="col-md-9" id="threats"></div>
    </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <script>
    $(document).ready(function () {
    var csrf_token = '{{ csrf_token() }}';

    function _accordionItem(counter, title, description) {
        return `<div class="accordion-item">
            <h2 class="accordion-header" id="heading${counter}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                 data-bs-target="#collapse${counter}" aria-expanded="false" aria-controls="collapse${counter}">
                    ${title}
                </button>
            </h2>
            <div id="collapse${counter}" class="accordion-collapse collapse" 
            aria-labelledby="heading${counter}" data-bs-parent="#accordionCool">
                <div class="accordion-body">
                    <strong>${description}</strong>
                    <ul class=""></ul>
                </div>
            </div>
        </div>`
    }

    function renderThreats(activeId) {
        $('#threats').empty();
        $.ajax({
        url: '{{ url_for("api.get_threats") }}',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrf_token
        },
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({
            'ar_id': '{{ analysis_risk.id }}',
            'ac_id': activeId,
        }),
        success: (data, textStatus, jqXHR) => {

            let accordion = $('<div class="accordion accordion-flush" id="accordionCool">');
            let counter = 0;

            for (let threatId in data) {

                counter++;
                let threat = data[threatId];
                let accordionItem = $(_accordionItem(counter, threat.title, threat.description));
                let ul = accordionItem.find("ul");

                for (let actionId in threat.adverse_actions) {

                    let action = threat.adverse_actions[actionId];
                    let scoreContainer = $(
                    `<div class="d-flex justify-content-between align-items-center mb-2 data-id="${actionId}"">
                        <span>${action.title} - ${action.description}</span>
                        <div class="d-flex justify-content-between" id="score-inputs">
                        </div>
                    </div>`
                    );

                    let updateButton = $(
                        `<button type="button" class="btn btn-success
                         m-1" disabled><i class="bi bi-check-lg"></i></button>`
                    )

                    let isFetching = false;
                    let scoreInputs = scoreContainer.find("#score-inputs");
                    for (let score in action.score){
                        let input = $(
                            `<input class="form-control text-center m-1" style="width: 50px;"
                            title="${score}" data-bs-toggle="tooltip" data-bs-placement="top" id="${score}"
                            data-score-type=${score} value = "${action.score[score]}" >`
                        );

                        input.change(function(){
                            if(!isFetching) updateButton.prop("disabled", false)
                        })
                        scoreInputs.append(input);
                    }

                    scoreInputs.append(updateButton);
                    
                    ul.append(scoreContainer);
                    let id = scoreContainer.data("id");

                    scoreContainer.find("button").click(function () {
                        isFetching = true
                        updateButton.prop("disabled", true);
                        updateButton.empty();
                        updateButton.append(`<div class="spinner-border spinner-border-sm" role="status"></div>`);
                        let scores = {}
                        for(let score in action.score)
                        {
                            let input = scoreContainer.find(`#${score}`);
                            scores[score] = input.val();
                        }   
                        
                        $.ajax({
                        url: '{{ url_for("api.update_adverse_action_score") }}',
                        type: 'POST',
                        data: JSON.stringify({
                            ad_id: id, scores: scores
                        }),
                        contentType: 'application/json',
                        dataType: 'json',
                        headers: {
                            'X-CSRFToken': csrf_token
                        },
                        success: (data, textStatus, jqXHR) => {
                            isFetching = false;
                            updateButton.empty();
                            updateButton.append(`<i class="bi bi-check-lg"></i>`);
                            console.log(data)

                        },
                        error: (error) => {
                            console.log(error);
                        }
                        });
                    });
                }
                accordion.append(accordionItem);
            }
            $('#threats').append(accordion);
            $('[data-bs-toggle="tooltip"]').tooltip();
        }
        });
    }

    $.ajax({
        url: '{{ url_for("api.get_actives") }}',
        type: 'POST',
        headers: {
        'X-CSRFToken': csrf_token
        },
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify({
        'ar_id': '{{ analysis_risk.id }}'
        }),
        success: (data, textStatus, jqXHR) => {
        $('#actives').empty();
        let listGroup = $('<div class="list-group">');
        data.actives.forEach((active, index) => {
            let listItem = $(`<button class="list-group-item list-group-item-action py-2" data-id="${active.id}">
            ${active.title}</button>`);
            listItem.click(() => {
            renderThreats(active.id);
            });
            listGroup.append(listItem);
        });
        $('#actives').append(listGroup);
        },
        error: (error) => {
        console.log(error);
        }
    });
    });
    </script>
    {% endblock %}